<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Incubator Dashboard</title>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background: #f4f6fb;
    margin: 0;
    padding: 0;
  }
  .navbar {
    background: #2d3e50;
    color: #fff;
    padding: 0 30px;
    display: flex;
    align-items: center;
    height: 60px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
  }
  .navbar h1 {
    font-size: 1.5rem;
    margin: 0;
    flex: 1;
    letter-spacing: 1px;
  }
  .nav-links {
    display: flex;
    gap: 20px;
  }
  .nav-link {
    color: #fff;
    text-decoration: none;
    font-weight: 500;
    font-size: 1rem;
    padding: 8px 16px;
    border-radius: 4px;
    transition: background 0.2s;
    cursor: pointer;
  }
  .nav-link.active, .nav-link:hover {
    background: #1abc9c;
    color: #fff;
  }
  .container {
    max-width: 800px;
    margin: 30px auto;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 24px rgba(44,62,80,0.08);
    padding: 32px 40px 40px 40px;
    min-height: 500px;
  }
  h2 {
    color: #2d3e50;
    margin-top: 0;
  }  
  .status {
    font-size: 1.1rem;
    margin: 10px 0 20px 0;
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #1abc9c;
  }
  .controls button {
    margin: 8px 8px 8px 0;
    padding: 10px 18px;
    font-size: 1rem;
    border: none;
    border-radius: 5px;
    background: #1abc9c;
    color: #fff;
    cursor: pointer;
    transition: background 0.2s;
    box-shadow: 0 2px 6px rgba(44,62,80,0.07);
  }
  .controls button:hover {
    background: #16a085;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 18px;
    background: #fafbfc;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 0 10px rgba(0,0,0,0.05);
  }
  thead tr {
    background: linear-gradient(135deg, #1abc9c, #16a085);
    color: white;
  }  
  th, td {
    padding: 8px 15px;
    text-align: center;
    border-bottom: 1px solid #eaeaea;
    font-size: 0.9rem;
  }
  th {
    background: transparent;
    font-weight: 600;
    letter-spacing: 0.5px;
  }
  tbody tr:hover {
    background-color: #f2f6f9;
  }
  tbody tr:last-child td {
    border-bottom: none;
  }
  #alert {
    color: #e74c3c;
    font-weight: bold;
    font-size: 1.1rem;
  }
  @media (max-width: 900px) {
    .container { padding: 18px 5vw; }
  }
  .chart-container {
    position: relative;
    height: 240px;
    margin-bottom: 20px;
    background: #fff;
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 4px 15px rgba(44,62,80,0.08);
    transition: all 0.3s ease;
  }
  
  .chart-container:hover {
    box-shadow: 0 6px 20px rgba(44,62,80,0.12);
    transform: translateY(-2px);
  }
  
  .chart-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #2d3e50;
    margin-bottom: 10px;
    padding-bottom: 8px;
    border-bottom: 1px solid #eaeaea;
  }

  /* Control Panel Styles */
  .control-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* Changed to 3-column layout */
    gap: 20px;
    margin-top: 20px;
  }
  
  .control-card {
    background: #fff;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(44,62,80,0.08);
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  
  .control-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(44,62,80,0.12);
  }
  
  .control-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #2d3e50;
    margin-bottom: 15px;
    text-align: center;
  }
  
  .control-icon {
    width: 60px;
    height: 60px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: linear-gradient(135deg, #f5f7fa, #eef2f7);
    color: #1abc9c;
    font-size: 24px;
  }
  
  .control-buttons {
    display: flex;
    gap: 10px;
    width: 100%;
  }
  
  .btn-control {
    flex: 1;
    padding: 10px 18px;
    font-size: 0.9rem;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }
  
  .btn-on {
    background: #1abc9c;
    color: #fff;
  }
  
  .btn-on:hover {
    background: #16a085;
  }
  
  .btn-off {
    background: #f8f9fa;
    color: #2d3e50;
    border: 1px solid #e0e0e0;
  }
  
  .btn-off:hover {
    background: #e9ecef;
  }
  
  .status-indicator {
    margin-top: 12px;
    font-size: 0.85rem;
    color: #666;
  }
  
  .status-on {
    color: #1abc9c;
    font-weight: 500;
  }
  
  .status-off {
    color: #95a5a6;
  }

  /* History Page Styles */
  .filter-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    align-items: center;
  }
  
  .filter-group {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .filter-label {
    font-size: 0.9rem;
    color: #566573;
    font-weight: 500;
  }
  
  .filter-select {
    padding: 8px 12px;
    border-radius: 5px;
    border: 1px solid #ddd;
    background: white;
    font-size: 0.9rem;
    color: #2d3e50;
    cursor: pointer;
  }
  
  .date-input {
    padding: 8px 12px;
    border-radius: 5px;
    border: 1px solid #ddd;
    font-size: 0.9rem;
  }
  
  .btn-filter {
    background: #1abc9c;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 8px 16px;
    font-size: 0.9rem;
    cursor: pointer;
    margin-left: auto;
  }
  
  .btn-filter:hover {
    background: #16a085;
  }
  
  .history-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 0 15px rgba(0,0,0,0.05);
  }
  
  .history-table th {
    background: linear-gradient(135deg, #1abc9c, #16a085);
    color: white;
    padding: 12px 15px;
    text-align: left;
    font-weight: 600;
  }
  
  .history-table td {
    padding: 12px 15px;
    border-bottom: 1px solid #eaeaea;
  }
  
  .history-table tr:nth-child(even) {
    background-color: #f8f9fa;
  }
  
  .history-table tr:hover {
    background-color: #f1f8f6;
  }
  
  .history-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 20px;
  }
  
  .stat-card {
    flex: 1;
    min-width: 180px;
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  
  .stat-title {
    font-size: 0.9rem;
    color: #7f8c8d;
    margin-bottom: 8px;
  }
  
  .stat-value {
    font-size: 1.8rem;
    font-weight: 600;
    color: #2d3e50;
  }
  
  .temp-value {
    color: rgba(255, 99, 132, 1);
  }
  
  .humid-value {
    color: rgba(54, 162, 235, 1);
  }
  
  .no-data {
    text-align: center;
    padding: 30px;
    color: #7f8c8d;
    font-style: italic;
  }

  /* Statistics and Chart Styles */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-top: 15px;
  }
  
  .stats-card {
    background: #fff;
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 4px 15px rgba(44,62,80,0.08);
    transition: all 0.3s ease;
  }
  
  .stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(44,62,80,0.12);
  }
  
  .stats-title {
    font-size: 1rem;
    font-weight: 600;
    color: #2d3e50;
    margin-bottom: 10px;
  }
  
  .chart-container {
    position: relative;
    height: 300px;
    margin-top: 15px;
    background: #fff;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(44,62,80,0.08);
    transition: all 0.3s ease;
  }
  
  .chart-container:hover {
    box-shadow: 0 6px 20px rgba(44,62,80,0.12);
    transform: translateY(-2px);
  }
  
  .chart-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #2d3e50;
    margin-bottom: 10px;
    padding-bottom: 8px;
    border-bottom: 1px solid #eaeaea;
  }

  .loading {
    text-align: center; 
    padding: 20px;
    color: #7f8c8d;
    font-style: italic;
  }

  /* Toggle Switch Styles */
  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
  }
  
  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  
  .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 34px;
  }
  
  .toggle-slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }
  
  input:checked + .toggle-slider {
    background-color: #1abc9c;
  }
  
  input:checked + .toggle-slider:before {
    transform: translateX(26px);
  }
  
  /* Range Slider Styles */
  .range-slider {
    position: relative;
    height: 5px;
    background-color: #ddd;
    border-radius: 5px;
    margin: 35px 0;
  }
  
  .range-slider input {
    position: absolute;
    width: 100%;
    height: 5px;
    top: -5px;
    background: none;
    pointer-events: none;
    -webkit-appearance: none;
  }
  
  .range-slider input::-webkit-slider-thumb {
    height: 20px;
    width: 20px;
    border-radius: 50%;
    border: 3px solid #1abc9c;
    background: white;
    pointer-events: auto;
    -webkit-appearance: none;
    cursor: pointer;
  }
  
  .range-slider-track {
    position: absolute;
    height: 5px;
    background-color: #1abc9c;
    border-radius: 5px;
    top: 0;
  }
  
  .save-button {
    background: #1abc9c;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 12px 20px;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s;
    display: block;
    margin: 0 auto;
    font-weight: 500;
  }
  
  .save-button:hover {
    background: #16a085;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(22, 160, 133, 0.2);
  }
</style>
</head>
<body>
<div class="navbar">
  <h1>Incubator Dashboard</h1>
  <div class="nav-links">
    <span class="nav-link active" onclick="showPage('video')" id="nav-video">Gi√°m s√°t Video</span>
    <span class="nav-link" onclick="showPage('sensor')" id="nav-sensor">Theo d√µi D·ªØ li·ªáu</span>
    <span class="nav-link" onclick="showPage('control')" id="nav-control">ƒêi·ªÅu khi·ªÉn</span>
    <span class="nav-link" onclick="showPage('history')" id="nav-history">L·ªãch s·ª≠</span>
  </div>
</div>
<div class="container">
  <!-- Video Page -->
  <div id="page-video">
    <h2>Gi√°m s√°t Video</h2>
    <img id="video-stream" src="http://172.20.10.2/stream" alt="ESP32-CAM Video" width="100%" style="max-width:640px; border-radius:10px; box-shadow:0 2px 12px rgba(44,62,80,0.09);" />
  </div>
  <!-- Sensor Page -->
  <div id="page-sensor" style="display:none;">    
    <h2>Theo d√µi D·ªØ li·ªáu C·∫£m bi·∫øn</h2>    
    <div class="status">      
      <div style="display:flex; flex-wrap:wrap; justify-content:space-around; align-items:center; margin-bottom:8px;">
        <div class="sensor-circle" style="position:relative; width:150px; height:150px; margin:8px; display:flex; flex-direction:column; justify-content:center; align-items:center; border-radius:50%; background:linear-gradient(135deg, #f5f7fa, #eef2f7); box-shadow:0 4px 15px rgba(44,62,80,0.08);">
          <div style="position:absolute; top:0; left:0; width:100%; height:100%; border-radius:50%; border:8px solid rgba(255, 99, 132, 0.7); box-sizing:border-box;"></div>
          <span style="font-size:2.5rem; font-weight:bold; color:rgba(255, 99, 132, 1);" id="temp">-</span>
          <span style="font-size:0.9rem; color:#666; margin-top:3px;">¬∞C</span>
          <span style="font-size:1rem; color:#2d3e50; margin-top:3px;">Nhi·ªát ƒë·ªô</span>
        </div>
        
        <div class="sensor-circle" style="position:relative; width:150px; height:150px; margin:8px; display:flex; flex-direction:column; justify-content:center; align-items:center; border-radius:50%; background:linear-gradient(135deg, #f5f7fa, #eef2f7); box-shadow:0 4px 15px rgba(44,62,80,0.08);">
          <div style="position:absolute; top:0; left:0; width:100%; height:100%; border-radius:50%; border:8px solid rgba(54, 162, 235, 0.7); box-sizing:border-box;"></div>
          <span style="font-size:2.5rem; font-weight:bold; color:rgba(54, 162, 235, 1);" id="humidity">-</span>
          <span style="font-size:0.9rem; color:#666; margin-top:3px;">%</span>
          <span style="font-size:1rem; color:#2d3e50; margin-top:3px;">ƒê·ªô ·∫©m</span>
        </div>
      </div>
      <span id="alert" style="display:block; padding:6px 0; text-align:center; margin-top:8px; background-color:#fee; border-radius:5px; font-size:1rem;">-</span>
      <span id="normal-status" style="display:none; color:#27ae60; font-weight:500; font-size:1rem; text-align:center; margin-top:8px;">‚úÖ Nhi·ªát ƒë·ªô v√† ƒë·ªô ·∫©m b√¨nh th∆∞·ªùng</span>
    </div>    
    <div style="display:flex; flex-direction:column; gap:15px; margin:15px 0;">
        <!-- Temperature Chart -->
        <div class="chart-container">
          <div class="chart-title">Bi·ªÉu ƒë·ªì Nhi·ªát ƒë·ªô (¬∞C)</div>
          <canvas id="tempChart"></canvas>
        </div>
        <!-- Humidity Chart -->
        <div class="chart-container">
          <div class="chart-title">Bi·ªÉu ƒë·ªì ƒê·ªô ·∫©m (%)</div>
          <canvas id="humidityChart"></canvas>
        </div>
    </div>    
  </div>
  <!-- Control Page -->
  <div id="page-control" style="display:none;">
    <h2>ƒêi·ªÅu khi·ªÉn Thi·∫øt b·ªã</h2>
    <p style="color:#666; margin-bottom:20px;">Qu·∫£n l√Ω v√† ki·ªÉm so√°t c√°c thi·∫øt b·ªã trong l·ªìng ·∫•p ƒë·ªÉ t·∫°o m√¥i tr∆∞·ªùng t·ªëi ∆∞u.</p>
    
    <div class="control-grid">
      <!-- Fan Control -->
      <div class="control-card">
        <div class="control-icon">üí®</div>
        <div class="control-title">Qu·∫°t Th√¥ng Gi√≥</div>
        <div class="control-buttons">
          <button class="btn-control btn-on" onclick="sendCommand('turnOnFan')">B·∫≠t</button>
          <button class="btn-control btn-off" onclick="sendCommand('turnOffFan')">T·∫Øt</button>
        </div>
        <div class="status-indicator" id="fan-status">Tr·∫°ng th√°i: <span class="status-off">ƒêang t·∫Øt</span></div>
      </div>
      
      <!-- Door Control -->
      <div class="control-card">
        <div class="control-icon">üö™</div>
        <div class="control-title">C·ª≠a S·ªï</div>
        <div class="control-buttons">
          <button class="btn-control btn-on" onclick="sendCommand('openDoor')">M·ªü</button>
          <button class="btn-control btn-off" onclick="sendCommand('closeDoor')">ƒê√≥ng</button>
        </div>
        <div class="status-indicator" id="door-status">Tr·∫°ng th√°i: <span class="status-off">ƒêang ƒë√≥ng</span></div>
      </div>
      
      <!-- Light Control -->
      <div class="control-card">
        <div class="control-icon">üí°</div>
        <div class="control-title">ƒê√®n Chi·∫øu S√°ng</div>
        <div class="control-buttons">
          <button class="btn-control btn-on" onclick="sendCommand('turnOnLight')">B·∫≠t</button>
          <button class="btn-control btn-off" onclick="sendCommand('turnOffLight')">T·∫Øt</button>
        </div>
        <div class="status-indicator" id="light-status">Tr·∫°ng th√°i: <span class="status-off">ƒêang t·∫Øt</span></div>
      </div>
    </div>
    
    <!-- Auto Control Section -->
    <div class="auto-control-section" style="margin-top: 30px; background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 4px 15px rgba(44,62,80,0.08);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0; color: #2d3e50;">Gi√° tr·ªã l√Ω t∆∞·ªüng</h3>
        
        <span style="margin-left: 400px;">Ch·∫ø ƒë·ªô t·ª± ƒë·ªông</span>
        <label class="toggle-switch">
          <input type="checkbox" id="auto-toggle" onchange="toggleAutoMode(this.checked)">
          <span class="toggle-slider"></span>
          <!-- <span style="margin-left: 10px; font-size: 0.9rem; color: #666;">T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh</span> -->
        </label>
      </div>
      
      <div id="auto-settings">
        <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
          <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <label style="font-weight: 500; color: #2d3e50;">Ph·∫°m vi Nhi·ªát ƒë·ªô (¬∞C):</label>
              <span id="temp-range-display">36¬∞C - 38¬∞C</span>
            </div>
            <div class="range-slider">
              <input type="range" min="20" max="50" step="0.5" value="36" id="temp-min" oninput="updateRangeDisplay()">
              <input type="range" min="20" max="50" step="0.5" value="38" id="temp-max" oninput="updateRangeDisplay()">
              <div class="range-slider-track"></div>
            </div>
          </div>
          
          <div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <label style="font-weight: 500; color: #2d3e50;">Ph·∫°m vi ƒê·ªô ·∫©m (%):</label>
              <span id="humidity-range-display">55% - 70%</span>
            </div>
            <div class="range-slider">
              <input type="range" min="40" max="90" step="1" value="55" id="humidity-min" oninput="updateRangeDisplay()">
              <input type="range" min="40" max="90" step="1" value="70" id="humidity-max" oninput="updateRangeDisplay()">
              <div class="range-slider-track"></div>
            </div>
          </div>
        </div>
          <button class="save-button" onclick="saveRangeSettings()">L∆∞u c√†i ƒë·∫∑t</button>
      </div>
      
      <!-- Th√™m ph·∫ßn m√¥ t·∫£ v·ªÅ c∆° ch·∫ø t·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh -->
      <div style="margin-top: 25px; background: #f8f9fa; border-radius: 8px; padding: 20px;">
        <h4 style="color: #2d3e50; margin-top: 0;">C∆° ch·∫ø t·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh</h4>
        <p style="color: #555; line-height: 1.5;">Khi b·∫≠t ch·∫ø ƒë·ªô t·ª± ƒë·ªông, h·ªá th·ªëng s·∫Ω ƒëi·ªÅu ch·ªânh c√°c thi·∫øt b·ªã nh∆∞ sau:</p>
        
        <div style="background: #fff; border-radius: 6px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
          <h5 style="color: #e74c3c; margin-top: 0; margin-bottom: 8px;">Nhi·ªát ƒë·ªô cao:</h5>
          <p style="margin: 0; color: #666;">B·∫≠t qu·∫°t, t·∫Øt ƒë√®n, m·ªü c·ª≠a.</p>
        </div>
        
        <div style="background: #fff; border-radius: 6px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
          <h5 style="color: #3498db; margin-top: 0; margin-bottom: 8px;">Nhi·ªát ƒë·ªô th·∫•p:</h5>
          <p style="margin: 0; color: #666;">T·∫Øt qu·∫°t, b·∫≠t ƒë√®n, ƒë√≥ng c·ª≠a.</p>
        </div>
        
        <div style="background: #fff; border-radius: 6px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
          <h5 style="color: #27ae60; margin-top: 0; margin-bottom: 8px;">Nhi·ªát ƒë·ªô b√¨nh th∆∞·ªùng:</h5>
          
          <div style="padding-left: 15px; margin-bottom: 10px;">
            <h6 style="color: #e74c3c; margin-top: 0; margin-bottom: 8px;">ƒê·ªô ·∫©m cao:</h6>
            <p style="margin: 0; color: #666;">B·∫≠t qu·∫°t, t·∫Øt ƒë√®n, ƒë√≥ng c·ª≠a.</p>
          </div>
          
          <div style="padding-left: 15px; margin-bottom: 10px;">
            <h6 style="color: #3498db; margin-top: 0; margin-bottom: 8px;">ƒê·ªô ·∫©m th·∫•p:</h6>
            <p style="margin: 0; color: #666;">T·∫Øt qu·∫°t, t·∫Øt ƒë√®n, m·ªü c·ª≠a.</p>
          </div>
          
          <div style="padding-left: 15px;">
            <h6 style="color: #27ae60; margin-top: 0; margin-bottom: 8px;">ƒê·ªô ·∫©m b√¨nh th∆∞·ªùng:</h6>
            <p style="margin: 0; color: #666;">T·∫Øt qu·∫°t, t·∫Øt ƒë√®n, ƒë√≥ng c·ª≠a.</p>
          </div>
        </div>
        
        <p style="color: #555; margin-bottom: 0;">H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ki·ªÉm tra v√† ƒëi·ªÅu ch·ªânh tr·∫°ng th√°i c√°c thi·∫øt b·ªã d·ª±a tr√™n gi√° tr·ªã l√Ω t∆∞·ªüng ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p.</p>
      </div>
    </div>
    
    <script>
      // Declare global variables for temperature and humidity ranges
      let idealTempMin = 36;
      let idealTempMax = 38;
      let idealHumidityMin = 55;
      let idealHumidityMax = 70;
      
      // Auto mode control functions
      function toggleAutoMode(isOn) {
        // Only send command to server, don't hide settings
        const command = isOn ? 'autoOn' : 'autoOff';
        sendCommand(command);
        
        // // Update UI to indicate auto mode status
        // const toggleLabel = document.querySelector('.toggle-switch span:last-child');
        // toggleLabel.textContent = isOn ? 'ƒêang t·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh' : 'T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh';
        // toggleLabel.style.color = isOn ? '#1abc9c' : '#666';
      }
      
      function updateRangeDisplay() {
        const tempMin = document.getElementById('temp-min').value;
        const tempMax = document.getElementById('temp-max').value;
        const humidityMin = document.getElementById('humidity-min').value;
        const humidityMax = document.getElementById('humidity-max').value;
        
        // Update global variables
        idealTempMin = parseFloat(tempMin);
        idealTempMax = parseFloat(tempMax);
        idealHumidityMin = parseFloat(humidityMin);
        idealHumidityMax = parseFloat(humidityMax);
        
        // Update display text
        document.getElementById('temp-range-display').textContent = `${tempMin}¬∞C - ${tempMax}¬∞C`;
        document.getElementById('humidity-range-display').textContent = `${humidityMin}% - ${humidityMax}%`;
        
        // Update track display
        updateRangeTrack('temp-min', 'temp-max');
        updateRangeTrack('humidity-min', 'humidity-max');
      }
      
      function updateRangeTrack(minId, maxId) {
        const minInput = document.getElementById(minId);
        const maxInput = document.getElementById(maxId);
        const track = minInput.parentElement.querySelector('.range-slider-track');
        
        const minVal = parseFloat(minInput.value);
        const maxVal = parseFloat(maxInput.value);
        const minPercent = ((minVal - parseFloat(minInput.min)) / (parseFloat(minInput.max) - parseFloat(minInput.min))) * 100;
        const maxPercent = ((maxVal - parseFloat(maxInput.min)) / (parseFloat(maxInput.max) - parseFloat(minInput.min))) * 100;
        
        track.style.left = minPercent + '%';
        track.style.width = (maxPercent - minPercent) + '%';
      }
      
      function saveRangeSettings() {
        // Create and send command with range settings
        const command = `range-${idealTempMin}-${idealTempMax}-${idealHumidityMin}-${idealHumidityMax}`;
        console.log('Sending command:', command);
        sendCommand(command);
        
        // Save to localStorage
        localStorage.setItem('idealTempMin', idealTempMin);
        localStorage.setItem('idealTempMax', idealTempMax);
        localStorage.setItem('idealHumidityMin', idealHumidityMin);
        localStorage.setItem('idealHumidityMax', idealHumidityMax);
        
        // Show confirmation message
        alert('C√†i ƒë·∫∑t ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!');
      }
      
      // Initialize ranges on page load
      document.addEventListener('DOMContentLoaded', function() {
        // Load from localStorage if available
        if (localStorage.getItem('idealTempMin')) {
          idealTempMin = parseFloat(localStorage.getItem('idealTempMin'));
          idealTempMax = parseFloat(localStorage.getItem('idealTempMax'));
          idealHumidityMin = parseFloat(localStorage.getItem('idealHumidityMin'));
          idealHumidityMax = parseFloat(localStorage.getItem('idealHumidityMax'));
          
          // Update range inputs
          document.getElementById('temp-min').value = idealTempMin;
          document.getElementById('temp-max').value = idealTempMax;
          document.getElementById('humidity-min').value = idealHumidityMin;
          document.getElementById('humidity-max').value = idealHumidityMax;
        }
        
        updateRangeDisplay();
      });
    </script>
  </div>
  <!-- History Page -->
  <div id="page-history" style="display:none;">
    <h2>L·ªãch s·ª≠ D·ªØ li·ªáu</h2>
    <p style="color:#666; margin-bottom:20px;">Xem l·∫°i v√† ph√¢n t√≠ch d·ªØ li·ªáu nhi·ªát ƒë·ªô v√† ƒë·ªô ·∫©m theo th·ªùi gian.</p>
    
    <div class="filter-bar">
      <div class="filter-group">
        <span class="filter-label">T·ª´ ng√†y:</span>
        <input type="date" id="from-date-input" class="date-input">
      </div>
      
      <div class="filter-group">
        <span class="filter-label">ƒê·∫øn ng√†y:</span>
        <input type="date" id="to-date-input" class="date-input">
      </div>
      
      <button class="btn-filter" onclick="filterHistoryData()">L·ªçc d·ªØ li·ªáu</button>
    </div>
    
    <!-- Statistical Summary Section -->
    <div id="statsSection" style="display:none; margin-bottom: 25px;">
      <h3 style="margin-top: 25px; margin-bottom: 15px; color: #2d3e50;">Ph√¢n t√≠ch d·ªØ li·ªáu</h3>
      <div class="stats-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
        <!-- Temperature Stats -->
        <div class="stats-card" style="background: #fff; border-radius: 10px; padding: 15px; box-shadow: 0 4px 15px rgba(44,62,80,0.08);">
          <h4 style="color: rgba(255, 99, 132, 1); margin-top: 0;">Th·ªëng k√™ Nhi·ªát ƒë·ªô</h4>
          <div class="stats-item">
            <div class="stats-label">Cao nh·∫•t:</div>
            <div class="stats-value" id="max-temp">--</div>
            <div class="stats-time" id="max-temp-time">--</div>
          </div>
          <div class="stats-item">
            <div class="stats-label">Th·∫•p nh·∫•t:</div>
            <div class="stats-value" id="min-temp">--</div>
            <div class="stats-time" id="min-temp-time">--</div>
          </div>
          <div class="stats-item">
            <div class="stats-label">Trung b√¨nh:</div>
            <div class="stats-value" id="avg-temp">--</div>
          </div>
        </div>
        <!-- Humidity Stats -->
        <div class="stats-card" style="background: #fff; border-radius: 10px; padding: 15px; box-shadow: 0 4px 15px rgba(44,62,80,0.08);">
          <h4 style="color: rgba(54, 162, 235, 1); margin-top: 0;">Th·ªëng k√™ ƒê·ªô ·∫©m</h4>
          <div class="stats-item">
            <div class="stats-label">Cao nh·∫•t:</div>
            <div class="stats-value" id="max-humid">--</div>
            <div class="stats-time" id="max-humid-time">--</div>
          </div>
          <div class="stats-item">
            <div class="stats-label">Th·∫•p nh·∫•t:</div>
            <div class="stats-value" id="min-humid">--</div>
            <div class="stats-time" id="min-humid-time">--</div>
          </div>
          <div class="stats-item">
            <div class="stats-label">Trung b√¨nh:</div>
            <div class="stats-value" id="avg-humid">--</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Chart Section -->
    <div id="historyChartSection" style="display:none; margin-bottom: 25px;">
      <h3 style="margin-top: 25px; margin-bottom: 15px; color: #2d3e50;">Bi·ªÉu ƒë·ªì d·ªØ li·ªáu</h3>
      
      <!-- Temperature Chart Container -->
      <div class="chart-container" style="position: relative; height: 300px; background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 4px 15px rgba(44,62,80,0.08); margin-bottom: 20px;">
        <div class="chart-title">Bi·ªÉu ƒë·ªì Nhi·ªát ƒë·ªô (¬∞C)</div>
        <canvas id="historyTempChart"></canvas>
      </div>
      
      <!-- Humidity Chart Container -->
      <div class="chart-container" style="position: relative; height: 300px; background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 4px 15px rgba(44,62,80,0.08);">
        <div class="chart-title">Bi·ªÉu ƒë·ªì ƒê·ªô ·∫©m (%)</div>
        <canvas id="historyHumidChart"></canvas>
      </div>
    </div>
    
    <style>
      .stats-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #f0f0f0;
      }
      .stats-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }
      .stats-label {
        flex: 1;
        font-weight: 500;
        color: #566573;
      }
      .stats-value {
        font-weight: 600;
        font-size: 1.1rem;
        margin-right: 10px;
        color: #2d3e50;
      }
      .stats-time {
        font-size: 0.85rem;
        color: #7f8c8d;
      }
    </style>
    
    <div id="historyLoading" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
    <div id="noDataMessage" style="display:none;">Kh√¥ng c√≥ d·ªØ li·ªáu l·ªãch s·ª≠</div>
    
    <table id="historyTable" style="display:none;">
      <thead>
        <tr>
          <th>Th·ªùi gian</th>
          <th>Nhi·ªát ƒë·ªô (¬∞C)</th>
          <th>ƒê·ªô ·∫©m (%)</th>
        </tr>
      </thead>
      <tbody id="historyData"></tbody>
    </table>
  </div>
</div>
<script>
  // Navigation logic
  const timeLabels = Array(20).fill('');
  const tempData = Array(20).fill(null);
  const humidityData = Array(20).fill(null);
  
  // Create variables for both history charts
  let historyTempChart = null;
  let historyHumidChart = null;
  
  // Temperature Chart
  const tempCtx = document.getElementById('tempChart').getContext('2d');
  const tempChart = new Chart(tempCtx, {
    type: 'line',
    data: {
      labels: timeLabels,
      datasets: [{
        label: 'Nhi·ªát ƒë·ªô (¬∞C)',
        data: tempData,
        borderColor: 'rgba(255, 99, 132, 1)',
        backgroundColor: 'rgba(255, 99, 132, 0.1)',
        borderWidth: 2,
        pointRadius: 3,
        pointBackgroundColor: 'rgba(255, 99, 132, 1)',
        pointBorderColor: '#fff',
        pointBorderWidth: 1,
        pointHoverRadius: 5,
        pointHoverBackgroundColor: 'rgba(255, 99, 132, 1)',
        pointHoverBorderColor: '#fff',
        tension: 0.3,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          // Set initial ranges that will be dynamically updated
          min: 25,
          max: 45,  
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          },
          ticks: {
            font: {
              size: 10
            }
          }
        },
        x: {
          grid: {
            display: false
          },
          ticks: {
            font: {
              size: 10
            },
            maxRotation: 0
          }
        }
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.7)',
          bodyFont: {
            size: 13
          },
          padding: 10,
          cornerRadius: 5,
          displayColors: false
        }
      },
      animation: {
        duration: 1000
      }
    }
  });
  
  // Humidity Chart
  const humidityCtx = document.getElementById('humidityChart').getContext('2d');
  const humidityChart = new Chart(humidityCtx, {
    type: 'line',
    data: {
      labels: timeLabels,
      datasets: [{
        label: 'ƒê·ªô ·∫©m (%)',
        data: humidityData,
        borderColor: 'rgba(54, 162, 235, 1)',
        backgroundColor: 'rgba(54, 162, 235, 0.1)',
        borderWidth: 2,
        pointRadius: 3,
        pointBackgroundColor: 'rgba(54, 162, 235, 1)',
        pointBorderColor: '#fff',
        pointBorderWidth: 1,
        pointHoverRadius: 5,
        pointHoverBackgroundColor: 'rgba(54, 162, 235, 1)',
        pointHoverBorderColor: '#fff',
        tension: 0.3,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          // Set initial ranges that will be dynamically updated
          min: 40,
          max: 80,
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          },
          ticks: {
            font: {
              size: 10
            }
          }
        },
        x: {
          grid: {
            display: false
          },
          ticks: {
            font: {
              size: 10
            },
            maxRotation: 0
          }
        }
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.7)',
          bodyFont: {
            size: 13
          },
          padding: 10,
          cornerRadius: 5,
          displayColors: false
        }
      },
      animation: {
        duration: 1000
      }
    }
  });

  // WebSocket connection setup
  const socket = new WebSocket(`ws://${window.location.hostname}:${window.location.port}`);
  let history = [];
  
  socket.onopen = () => {
    console.log('Connected to the WebSocket server');
  };
  
  socket.onclose = () => {
    console.log('Disconnected from the WebSocket server');
    // Try to reconnect after a delay
    setTimeout(() => {
      location.reload();
    }, 5000);
  };
  
  socket.onmessage = (event) => {
    try {
      const data = JSON.parse(event.data);
      
      console.log('Received data:', data);
      // when data format like this status-fan:on-light:off-door:close, update device status
      // Parse device status from string with format "status-fan:on-light:off-door:open"
      if (typeof data === 'string' && data.startsWith('status-')) {
        const statusParts = data.slice(7).split('-');
        statusParts.forEach(part => {
          const [device, status] = part.split(':');
          const statusElement = document.querySelector(`#${device}-status span`);
          if (statusElement) {
            statusElement.className = (status === 'on') || (status === 'open') ? 'status-on' : 'status-off';
            statusElement.textContent = (status === 'on') || (status === 'open') ? 'ƒêang ho·∫°t ƒë·ªông' : 'ƒêang t·∫Øt';
          }
        });
        return; // Skip further processing for status updates
      }


      if (data.temperature !== undefined && data.humidity !== undefined) {
        updateSensorData(data);
      } else if (data.action !== undefined) {
        updateControlStatus(data);
      }
    } catch (error) {
      console.error('Error processing WebSocket message:', error);
    }
  };
  
  function updateSensorData(data) {
    const temp = data.temperature;
    const humidity = data.humidity;
    const now = new Date();
    
    // Update the data entry
    const dataEntry = { 
      temperature: temp, 
      humidity, 
      timestamp: data.time,
    };
    
    // Store the last 20 data points for chart
    if (history.length > 20) history.shift();
    history.push(dataEntry);
    
    // Update UI elements
    document.getElementById('temp').innerText = temp;
    document.getElementById('humidity').innerText = humidity;
    
    // Update chart data
    timeLabels.shift();
    timeLabels.push(data.time);
    
    tempData.shift();
    tempData.push(temp);
    
    humidityData.shift();
    humidityData.push(humidity);
    
    // Update chart ranges based on current data history
    updateChartRanges();
    
    // Update both charts
    tempChart.update('none');
    humidityChart.update('none');
    
    // Alert if temperature or humidity is outside the ideal ranges
    let alertMsg = '';
    let alertColor = '#fee';
    const alertElement = document.getElementById('alert');
    const normalStatus = document.getElementById('normal-status');
      if (temp < idealTempMin || temp > idealTempMax) {
      alertMsg = `‚ö†Ô∏è Nhi·ªát ƒë·ªô b·∫•t th∆∞·ªùng! (L√Ω t∆∞·ªüng: ${idealTempMin}¬∞C - ${idealTempMax}¬∞C)`;
      alertColor = '#ffebee';
    }
    if (humidity < idealHumidityMin || humidity > idealHumidityMax) {
      alertMsg = alertMsg ? 
        `‚ö†Ô∏è Nhi·ªát ƒë·ªô & ƒê·ªô ·∫©m b·∫•t th∆∞·ªùng! (Nhi·ªát ƒë·ªô: ${idealTempMin}¬∞C - ${idealTempMax}¬∞C, ƒê·ªô ·∫©m: ${idealHumidityMin}% - ${idealHumidityMax}%)` : 
        `‚ö†Ô∏è ƒê·ªô ·∫©m b·∫•t th∆∞·ªùng! (L√Ω t∆∞·ªüng: ${idealHumidityMin}% - ${idealHumidityMax}%)`;
      alertColor = '#e8f4fd';
    }
    
    if (alertMsg) {
      alertElement.innerText = alertMsg;
      alertElement.style.backgroundColor = alertColor;
      alertElement.style.display = 'block';
      if (normalStatus) normalStatus.style.display = 'none';
    } else {
      // Hi·ªÉn th·ªã th√¥ng b√°o b√¨nh th∆∞·ªùng khi m·ªçi th·ª© ƒë·ªÅu ·ªïn
      alertElement.innerText = `‚úÖ M√¥i tr∆∞·ªùng l√Ω t∆∞·ªüng! (Nhi·ªát ƒë·ªô: ${idealTempMin}¬∞C - ${idealTempMax}¬∞C, ƒê·ªô ·∫©m: ${idealHumidityMin}% - ${idealHumidityMax}%)`;
      alertElement.style.backgroundColor = '#e8f8e8'; // M√†u xanh nh·∫π cho tr·∫°ng th√°i b√¨nh th∆∞·ªùng
      alertElement.style.display = 'block';
      if (normalStatus) normalStatus.style.display = 'block';
    }
  }
  
  // Function to update chart ranges dynamically based on history
  function updateChartRanges() {
    // Calculate temperature min/max values from history
    const tempValues = tempData.filter(val => val !== null);
    if (tempValues.length > 0) {
      const tempMin = Math.min(...tempValues) - 5;
      const tempMax = Math.max(...tempValues) + 5;
      tempChart.options.scales.y.min = tempMin;
      tempChart.options.scales.y.max = tempMax;
    }
    
    // Calculate humidity min/max values from history
    const humidValues = humidityData.filter(val => val !== null);
    if (humidValues.length > 0) {
      const humidMin = Math.min(...humidValues) - 5;
      const humidMax = Math.max(...humidValues) + 5;
      humidityChart.options.scales.y.min = humidMin;
      humidityChart.options.scales.y.max = humidMax;
    }
  }
  
  function updateControlStatus(data) {
    // Update UI based on command confirmation
    switch(data.action) {
      case 'turnOnFan':
        document.querySelector('#fan-status span').className = 'status-on';
        document.querySelector('#fan-status span').textContent = 'ƒêang ho·∫°t ƒë·ªông';
        break;
      case 'turnOffFan':
        document.querySelector('#fan-status span').className = 'status-off';
        document.querySelector('#fan-status span').textContent = 'ƒêang t·∫Øt';
        break;
      case 'openDoor':
        document.querySelector('#door-status span').className = 'status-on';
        document.querySelector('#door-status span').textContent = 'ƒêang m·ªü';
        break;
      case 'closeDoor':
        document.querySelector('#door-status span').className = 'status-off';
        document.querySelector('#door-status span').textContent = 'ƒêang ƒë√≥ng';
        break;
      case 'turnOnLight':
        document.querySelector('#light-status span').className = 'status-on';
        document.querySelector('#light-status span').textContent = 'ƒêang b·∫≠t';
        break;
      case 'turnOffLight':
        document.querySelector('#light-status span').className = 'status-off';
        document.querySelector('#light-status span').textContent = 'ƒêang t·∫Øt';
        break;
    }
  }

  function sendCommand(action) {
    // Send command via WebSocket
    if (socket.readyState === WebSocket.OPEN) {
      socket.send(JSON.stringify({ action }));
      console.log('Command sent via WebSocket:', action);
    } else {
      console.error('WebSocket not connected, using HTTP fallback');
      // Fallback to HTTP if WebSocket not available
      fetch(`${window.location.protocol}//${window.location.host}/control`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action })
      })
      .then(response => {
        if (response.ok) {
          // Update UI status indicators manually when using HTTP fallback
          updateControlStatus({ action });
        } else {
          alert('Error sending command. Please try again.');
        }
      })
      .catch(err => alert('Error sending command: ' + err));
    }
  }

  // History page functionality
  const mockHistoryData = {
    day: [],
    week: [],
    month: []
  };
  
  // Generate mock history data
  function generateMockData() {
    // Clear existing data
    mockHistoryData.day = [];
    mockHistoryData.week = [];
    mockHistoryData.month = [];
    
    // Generate current day data (24 hours, hourly readings)
    const today = new Date();
    for (let i = 0; i < 24; i++) {
      const date = new Date(today);
      date.setHours(i, 0, 0, 0);
      
      mockHistoryData.day.push({
        timestamp: date.toLocaleString('vi-VN', {hour: '2-digit', minute:'2-digit'}),
        fullDate: date,
        temperature: +(36 + Math.random() * 3 - 1.5).toFixed(2),
        humidity: +(60 + Math.random() * 10 - 5).toFixed(2)
      });
    }
    
    // Generate week data (7 days, 4 readings per day)
    for (let d = 6; d >= 0; d--) {
      const date = new Date(today);
      date.setDate(date.getDate() - d);
      
      for (let h of [6, 12, 18, 22]) {
        date.setHours(h, 0, 0, 0);
        
        mockHistoryData.week.push({
          timestamp: date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'}),
          fullDate: new Date(date),
          temperature: +(36 + Math.random() * 3 - 1.5).toFixed(2),
          humidity: +(60 + Math.random() * 10 - 5).toFixed(2)
        });
      }
    }
    
    // Generate month data (30 days, daily average)
    for (let d = 29; d >= 0; d--) {
      const date = new Date(today);
      date.setDate(date.getDate() - d);
      date.setHours(12, 0, 0, 0);
      
      mockHistoryData.month.push({
        timestamp: date.toLocaleDateString('vi-VN'),
        fullDate: new Date(date),
        temperature: +(36 + Math.random() * 3 - 1.5).toFixed(2),
        humidity: +(60 + Math.random() * 10 - 5).toFixed(2)
      });
    }
  }
  
  // Initialize mock data on page load
  // generateMockData();
  
  function loadHistoryData() {
    const historyTable = document.getElementById('historyTable');
    const loadingIndicator = document.getElementById('historyLoading');
    const noDataMessage = document.getElementById('noDataMessage');
    const statsSection = document.getElementById('statsSection');
    const chartSection = document.getElementById('historyChartSection');
    
    // Show loading, hide table and no data message
    loadingIndicator.style.display = 'block';
    historyTable.style.display = 'none';
    noDataMessage.style.display = 'none';
    statsSection.style.display = 'none';
    chartSection.style.display = 'none';
    
    // Build query parameters
    const fromDate = document.getElementById('from-date-input').value;
    const toDate = document.getElementById('to-date-input').value;
    const apiUrl = `/api/history?from_day=${fromDate}&to_day=${toDate}`;
    
    // Fetch data from API endpoint
    fetch(apiUrl)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        // Hide loading indicator
        loadingIndicator.style.display = 'none';
        
        if (data.length === 0) {
          // Show no data message
          noDataMessage.style.display = 'block';
          return;
        }
        
        // Show table and populate with data
        historyTable.style.display = 'table';
        const tbody = document.getElementById('historyData');
        tbody.innerHTML = ''; // Clear previous data
        
        // Sort data by timestamp (ascending)
        data.sort((a, b) => new Date(b.time) - new Date(a.time));
        
        // Process data for charts and statistics
        processHistoryData(data);
        
        // Show charts and stats sections
        statsSection.style.display = 'block';
        chartSection.style.display = 'block';
        
        // Populate table
        data.forEach(item => {
          const row = document.createElement('tr');
          
          // Format date
          const date = new Date(item.time);
          const formattedDate = date.toLocaleString();
          
          row.innerHTML = `
            <td>${formattedDate}</td>
            <td>${item.temperature}</td>
            <td>${item.humidity}</td>
          `;
          
          tbody.appendChild(row);
        });
      })
      .catch(error => {
        console.error('Error fetching history data:', error);
        loadingIndicator.style.display = 'none';
        document.getElementById('historyData').innerHTML = 
          '<tr><td colspan="3">Error loading data. Please try again.</td></tr>';
        historyTable.style.display = 'table';
      });
  }
  
  // Process history data for charts and statistics
  function processHistoryData(data) {
    if (!data || data.length === 0) return;
    
    // Extract data for charts
    const timestamps = data.map(item => {
      const date = new Date(item.time);
      return date.toLocaleString('vi-VN', {
        day: '2-digit',
        month: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    });
    
    const temperatures = data.map(item => item.temperature);
    const humidities = data.map(item => item.humidity);
    
    // Calculate statistics
    const tempStats = calculateStats(data, 'temperature');
    const humidStats = calculateStats(data, 'humidity');
    
    // Update statistics in the UI
    document.getElementById('max-temp').textContent = tempStats.max.toFixed(2) + ' ¬∞C';
    document.getElementById('min-temp').textContent = tempStats.min.toFixed(2) + ' ¬∞C';
    document.getElementById('avg-temp').textContent = tempStats.avg.toFixed(2) + ' ¬∞C';
    document.getElementById('max-temp-time').textContent = formatDateTime(tempStats.maxTime);
    document.getElementById('min-temp-time').textContent = formatDateTime(tempStats.minTime);
    
    document.getElementById('max-humid').textContent = humidStats.max.toFixed(2) + ' %';
    document.getElementById('min-humid').textContent = humidStats.min.toFixed(2) + ' %';
    document.getElementById('avg-humid').textContent = humidStats.avg.toFixed(2) + ' %';
    document.getElementById('max-humid-time').textContent = formatDateTime(humidStats.maxTime);
    document.getElementById('min-humid-time').textContent = formatDateTime(humidStats.minTime);
    
    // Create or update the separate charts
    createHistoryTempChart(timestamps, temperatures);
    createHistoryHumidChart(timestamps, humidities);
  }
  
  // Calculate statistics for a given property
  function calculateStats(data, property) {
    if (!data || data.length === 0) {
      return { min: 0, max: 0, avg: 0, minTime: null, maxTime: null };
    }
    
    let min = Infinity;
    let max = -Infinity;
    let sum = 0;
    let minTime = null;
    let maxTime = null;
    
    data.forEach(item => {
      const value = parseFloat(item[property]);
      
      if (value < min) {
        min = value;
        minTime = new Date(item.time);
      }
      
      if (value > max) {
        max = value;
        maxTime = new Date(item.time);
      }
      
      sum += value;
    });
    
    return {
      min,
      max,
      avg: sum / data.length,
      minTime,
      maxTime
    };
  }
  
  // Format date time for display
  function formatDateTime(date) {
    if (!date) return "--";
    return date.toLocaleString('vi-VN', {
      day: '2-digit',
      month: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
  }
  
  // Create or update temperature history chart
  function createHistoryTempChart(labels, tempData) {
    const ctx = document.getElementById('historyTempChart').getContext('2d');
    
    // Destroy previous chart if it exists
    if (historyTempChart) {
      historyTempChart.destroy();
    }
    
    // Create new temperature chart
    historyTempChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Nhi·ªát ƒë·ªô (¬∞C)',
            data: tempData,
            borderColor: 'rgba(255, 99, 132, 1)',
            backgroundColor: 'rgba(255, 99, 132, 0.1)',
            borderWidth: 2,
            pointRadius: 3,
            fill: true
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        scales: {
          x: {
            ticks: {
              maxRotation: 45,
              minRotation: 45
            },
            grid: {
              display: false
            }
          },
          y: {
            title: {
              display: true,
              text: 'Nhi·ªát ƒë·ªô (¬∞C)',
              color: 'rgba(255, 99, 132, 1)'
            },
            grid: {
              color: 'rgba(255, 99, 132, 0.1)'
            },
            ticks: {
              color: 'rgba(255, 99, 132, 1)'
            },
            // Dynamically set min/max based on data with some padding
            suggestedMin: Math.min(...tempData) - 5,
            suggestedMax: Math.max(...tempData) + 5
          }
        },
        plugins: {
          tooltip: {
            mode: 'index',
            intersect: false
          },
          legend: {
            position: 'top'
          }
        }
      }
    });
  }
  
  // Create or update humidity history chart
  function createHistoryHumidChart(labels, humidData) {
    const ctx = document.getElementById('historyHumidChart').getContext('2d');
    
    // Destroy previous chart if it exists
    if (historyHumidChart) {
      historyHumidChart.destroy();
    }
    
    // Create new humidity chart
    historyHumidChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'ƒê·ªô ·∫©m (%)',
            data: humidData,
            borderColor: 'rgba(54, 162, 235, 1)',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            borderWidth: 2,
            pointRadius: 3,
            fill: true
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        scales: {
          x: {
            ticks: {
              maxRotation: 45,
              minRotation: 45
            },
            grid: {
              display: false
            }
          },
          y: {
            title: {
              display: true,
              text: 'ƒê·ªô ·∫©m (%)',
              color: 'rgba(54, 162, 235, 1)'
            },
            grid: {
              color: 'rgba(54, 162, 235, 0.1)'
            },
            ticks: {
              color: 'rgba(54, 162, 235, 1)'
            },
            // Dynamically set min/max based on data with some padding
            suggestedMin: Math.min(...humidData) - 5,
            suggestedMax: Math.max(...humidData) + 5
          }
        },
        plugins: {
          tooltip: {
            mode: 'index',
            intersect: false
          },
          legend: {
            position: 'top'
          }
        }
      }
    });
  }
  
  // Replace the old createHistoryChart function
  function createHistoryChart(labels, tempData, humidData) {
    createHistoryTempChart(labels, tempData);
    createHistoryHumidChart(labels, humidData);
  }
  
  // Show and hide pages
  function showPage(page) {
    document.getElementById('page-video').style.display = (page === 'video') ? '' : 'none';
    document.getElementById('page-sensor').style.display = (page === 'sensor') ? '' : 'none';
    document.getElementById('page-control').style.display = (page === 'control') ? '' : 'none';
    document.getElementById('page-history').style.display = (page === 'history') ? '' : 'none';
    document.getElementById('nav-video').classList.toggle('active', page === 'video');
    document.getElementById('nav-sensor').classList.toggle('active', page === 'sensor');
    document.getElementById('nav-control').classList.toggle('active', page === 'control');
    document.getElementById('nav-history').classList.toggle('active', page === 'history');
    
    // Load history data when the history page is shown
    if (page === 'history') {
      setupDateInputs();
      loadHistoryData();
    }
  }

  // Setup date inputs with current date values
  function setupDateInputs() {
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    
    // Set default range to last 7 days
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);
    const weekAgoStr = weekAgo.toISOString().split('T')[0];
    
    document.getElementById('from-date-input').value = weekAgoStr;
    document.getElementById('to-date-input').value = todayStr;
  }
  
  // Filter history data based on selected date range
  function filterHistoryData() {
    loadHistoryData();
  }

  // Function to load history data from API
  function loadHistoryData() {
    const historyTable = document.getElementById('historyTable');
    const loadingIndicator = document.getElementById('historyLoading');
    const noDataMessage = document.getElementById('noDataMessage');
    const statsSection = document.getElementById('statsSection');
    const chartSection = document.getElementById('historyChartSection');
    
    // Show loading, hide table and no data message
    loadingIndicator.style.display = 'block';
    historyTable.style.display = 'none';
    noDataMessage.style.display = 'none';
    statsSection.style.display = 'none';
    chartSection.style.display = 'none';
    
    // Build query parameters
    const fromDate = document.getElementById('from-date-input').value;
    const toDate = document.getElementById('to-date-input').value;
    const apiUrl = `/api/history?from_day=${fromDate}&to_day=${toDate}`;
    
    // Fetch data from API endpoint
    fetch(apiUrl)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        // Hide loading indicator
        loadingIndicator.style.display = 'none';
        
        if (data.length === 0) {
          // Show no data message
          noDataMessage.style.display = 'block';
          return;
        }
        
        // Show table and populate with data
        historyTable.style.display = 'table';
        const tbody = document.getElementById('historyData');
        tbody.innerHTML = ''; // Clear previous data
          // Sort data by timestamp (descending - newest first)
        data.sort((a, b) => new Date(b.time) - new Date(a.time));
        
        // Process data for charts and statistics
        processHistoryData(data);
        
        // Show charts and stats sections
        statsSection.style.display = 'block';
        chartSection.style.display = 'block';
        
        // Populate table
        data.forEach(item => {
          const row = document.createElement('tr');
          
          // Format date
          const date = new Date(item.time);
          const formattedDate = date.toLocaleString();
          
          row.innerHTML = `
            <td>${formattedDate}</td>
            <td>${item.temperature}</td>
            <td>${item.humidity}</td>
          `;
          
          tbody.appendChild(row);
        });
      })
      .catch(error => {
        console.error('Error fetching history data:', error);
        loadingIndicator.style.display = 'none';
        document.getElementById('historyData').innerHTML = 
          '<tr><td colspan="3">Error loading data. Please try again.</td></tr>';
        historyTable.style.display = 'table';
      });
  }
  
  // Process history data for charts and statistics
  function processHistoryData(data) {
    if (!data || data.length === 0) return;
    
    // Extract data for charts
    const timestamps = data.map(item => {
      const date = new Date(item.time);
      return date.toLocaleString('vi-VN', {
        day: '2-digit',
        month: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    });
    
    const temperatures = data.map(item => item.temperature);
    const humidities = data.map(item => item.humidity);
    
    // Calculate statistics
    const tempStats = calculateStats(data, 'temperature');
    const humidStats = calculateStats(data, 'humidity');
    
    // Update statistics in the UI
    document.getElementById('max-temp').textContent = tempStats.max.toFixed(2) + ' ¬∞C';
    document.getElementById('min-temp').textContent = tempStats.min.toFixed(2) + ' ¬∞C';
    document.getElementById('avg-temp').textContent = tempStats.avg.toFixed(2) + ' ¬∞C';
    document.getElementById('max-temp-time').textContent = formatDateTime(tempStats.maxTime);
    document.getElementById('min-temp-time').textContent = formatDateTime(tempStats.minTime);
    
    document.getElementById('max-humid').textContent = humidStats.max.toFixed(2) + ' %';
    document.getElementById('min-humid').textContent = humidStats.min.toFixed(2) + ' %';
    document.getElementById('avg-humid').textContent = humidStats.avg.toFixed(2) + ' %';
    document.getElementById('max-humid-time').textContent = formatDateTime(humidStats.maxTime);
    document.getElementById('min-humid-time').textContent = formatDateTime(humidStats.minTime);
    
    // Create or update the separate charts
    createHistoryTempChart(timestamps, temperatures);
    createHistoryHumidChart(timestamps, humidities);
  }
  
  // Calculate statistics for a given property
  function calculateStats(data, property) {
    if (!data || data.length === 0) {
      return { min: 0, max: 0, avg: 0, minTime: null, maxTime: null };
    }
    
    let min = Infinity;
    let max = -Infinity;
    let sum = 0;
    let minTime = null;
    let maxTime = null;
    
    data.forEach(item => {
      const value = parseFloat(item[property]);
      
      if (value < min) {
        min = value;
        minTime = new Date(item.time);
      }
      
      if (value > max) {
        max = value;
        maxTime = new Date(item.time);
      }
      
      sum += value;
    });
    
    return {
      min,
      max,
      avg: sum / data.length,
      minTime,
      maxTime
    };
  }
  
  // Format date time for display
  function formatDateTime(date) {
    if (!date) return "--";
    return date.toLocaleString('vi-VN', {
      day: '2-digit',
      month: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
  }
  
  // Create or update temperature history chart
  function createHistoryTempChart(labels, tempData) {
    const ctx = document.getElementById('historyTempChart').getContext('2d');
    
    // Destroy previous chart if it exists
    if (historyTempChart) {
      historyTempChart.destroy();
    }
    
    // Create new temperature chart
    historyTempChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Nhi·ªát ƒë·ªô (¬∞C)',
            data: tempData,
            borderColor: 'rgba(255, 99, 132, 1)',
            backgroundColor: 'rgba(255, 99, 132, 0.1)',
            borderWidth: 2,
            pointRadius: 3,
            fill: true
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        scales: {
          x: {
            ticks: {
              maxRotation: 45,
              minRotation: 45
            },
            grid: {
              display: false
            }
          },
          y: {
            title: {
              display: true,
              text: 'Nhi·ªát ƒë·ªô (¬∞C)',
              color: 'rgba(255, 99, 132, 1)'
            },
            grid: {
              color: 'rgba(255, 99, 132, 0.1)'
            },
            ticks: {
              color: 'rgba(255, 99, 132, 1)'
            },
            // Dynamically set min/max based on data with some padding
            suggestedMin: Math.min(...tempData) - 5,
            suggestedMax: Math.max(...tempData) + 5
          }
        },
        plugins: {
          tooltip: {
            mode: 'index',
            intersect: false
          },
          legend: {
            position: 'top'
          }
        }
      }
    });
  }
  
  // Create or update humidity history chart
  function createHistoryHumidChart(labels, humidData) {
    const ctx = document.getElementById('historyHumidChart').getContext('2d');
    
    // Destroy previous chart if it exists
    if (historyHumidChart) {
      historyHumidChart.destroy();
    }
    
  // Create new humidity chart
    historyHumidChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'ƒê·ªô ·∫©m (%)',
            data: humidData,
            borderColor: 'rgba(54, 162, 235, 1)',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            borderWidth: 2,
            pointRadius: 3,
            fill: true
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        scales: {
          x: {
            ticks: {
              maxRotation: 45,
              minRotation: 45
            },
            grid: {
              display: false
            }
          },
          y: {
            title: {
              display: true,
              text: 'ƒê·ªô ·∫©m (%)',
              color: 'rgba(54, 162, 235, 1)'
            },
            grid: {
              color: 'rgba(54, 162, 235, 0.1)'
            },
            ticks: {
              color: 'rgba(54, 162, 235, 1)'
            },
            // Dynamically set min/max based on data with some padding
            suggestedMin: Math.min(...humidData) - 5,
            suggestedMax: Math.max(...humidData) + 5
          }
        },
        plugins: {
          tooltip: {
            mode: 'index',
            intersect: false
          },
          legend: {
            position: 'top'
          }
        }
      }
    });
  }
  
  // Replace the old createHistoryChart function
  function createHistoryChart(labels, tempData, humidData) {
    createHistoryTempChart(labels, tempData);
    createHistoryHumidChart(labels, humidData);
  }
</script>
</body>
</html>
